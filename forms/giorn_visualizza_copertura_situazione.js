/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A7BD7C16-CAA4-4B48-8CC2-BCCD50322BDA",variableType:4}
 */
var vChkSituazione = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0EB02FC7-E728-42A6-A214-940E55C603A6",variableType:4}
 */
var vChkSingolaDitta = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C4DB49C4-33E5-447F-8D7E-052760DAF153",variableType:4}
 */
var vIdDitta = -1;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"FCDA4FE8-9D4F-40EC-94D5-2F2127D60990"}
 */
var vDitta = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AD88A2F8-AB8C-4565-AEB0-67F07223DB03",variableType:4}
 */
var vIdDip = -1;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"80CA6591-9AA3-40EB-AFB1-22EE2354955A"}
 */
var vDip = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"1E851902-6C2F-47A5-9C33-3D98531CF1AD",variableType:4}
 */
var vChkDip = 0;

/**
 * @properties={typeid:35,uuid:"A93830D8-098A-43D8-A6B3-7BE06D3A9FB6",variableType:-4}
 */
var vLastSelection =
{
	dal                 : null,
	al                  : null,
	chk_group_id        : 0,
	group_id            : -1,
	group_nome          : "",
	chk_centro_costo_id : 0,
	centro_costo_id     : null,
	centro_costo_nome   : "",
	chk_sede_id         : 0,
	sede_id             : null,
	sede_nome           : "",
	dettaglio_eventi    : 1,
	solo_richieste      : 0
}
/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"1F975A09-CB93-4D28-A823-5013B314D33B",variableType:93}
 */
var vDal = null;
/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"C07D3168-D8C5-4283-AAC5-D54D6A7D41D3",variableType:93}
 */
var vAl = null;
/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"CB7D5671-4C94-46A8-8A6A-3F6B96F92E8E",variableType:8}
 */
var vGroupId = -1;

/**
 * @type {Array<Number>}
 * 
 * @properties={typeid:35,uuid:"312EA9CD-75B6-4D10-A96C-CEC2A6EA2E3E",variableType:-4}
 */
var vArrGroupId = [];

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"ED17753E-3912-40BC-9767-2B6C743535F6"}
 */
var vGroup = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"40B9C7A6-6EA7-46B4-96B0-1F5C8E8D2C68",variableType:4}
 */
var vChkCentroDiCosto = 0;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"08AFF685-545E-4937-AE0F-DA4C7D6937C0",variableType:4}
 */
var vChkSedeDiLavoro = 0;
/**
 * @type {Number}
 *  
 * @properties={typeid:35,uuid:"B607A4F2-3D2C-4827-98FD-C1239531D1DA",variableType:8}
 */
var vIdSede = null;

/**
 * @type {Array<Number>}
 *  
 * @properties={typeid:35,uuid:"9B4DF120-64C7-4C92-84F3-772423041CE1",variableType:-4}
 */
var vArrIdSede = [];

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5C6FA00E-B45E-4BB0-9D6B-0CA21C2B7A75"}
 */
var vSede = '';
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4290B285-56A9-4D0C-9AAF-0B82A7C08A9F",variableType:4}
 */
var vChkGruppo = 0;
/**
 * @type {Number}
 *  
 * @properties={typeid:35,uuid:"DA8D167E-5B45-4C08-8780-06AA4126A408",variableType:8}
 */
var vCodCentroDiCosto = null;

/**
 * @type {Array<String>}
 * 
 * @properties={typeid:35,uuid:"3AA44DF7-5C41-46D9-B0A6-5D616F039EB9",variableType:-4}
 */
var vArrCodCentroDiCosto = [];

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1C8B3F60-0C4D-484A-80FC-1288C8162597"}
 */
var vCentroDiCosto = '';
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"65FAE9CA-6808-4580-AFAC-4ECAED8A8312",variableType:4}
 */
var vChkDettaglioEvento = 1;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F4684609-B20F-4BA8-9ADE-30AEE9F9EACA",variableType:4}
 */
var vTipoVisualizzazione = 1;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D05AB5B1-BED7-4D05-8FDF-9003178483F1",variableType:4}
 */
var vSoloDipConRichieste = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8963861E-2BDF-4F2C-BD67-BDBAAFBF6C90",variableType:4}
 */
var vTipoRichieste = 1;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2758E286-D49B-43CE-B794-CB91338252E0",variableType:4}
 */
var vChkGruppoFasce = 0;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"D35A3277-CCA5-4952-9071-0C7D8A3DC213",variableType:8}
 */
var vIdGruppoFasce = null;

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"653BD3E4-A435-4C0E-B264-650ED1FF87D2"}
 * @AllowToRunInFind
 */
function onActionRefresh(event) {
	
	if(validaDate() && validaParametri())
	{	
		var params = {
	        processFunction: process_refresh,
	        message: '', 
	        opacity: 0.2,
	        paneColor: '#434343',
	        textColor: '#EC1C24',
	        showCancelButton: false,
	        cancelButtonText: '',
	        dialogName : 'This is the dialog',
	        fontType: 'Arial,4,35',
	        processArgs: [event]
	    };
		plugins.busy.block(params);	
	}
}

/**
 * @param {JSEvent} event
 *
 * @properties={typeid:24,uuid:"9CE34434-EC61-4A10-A099-9773CA8368D1"}
 */
function process_refresh(event)
{
	try
	{
		setLastSelection(event);	
		forms.giorn_visualizza_copertura.refreshCoperturaGiornaliera(event);
		goToBrowseVisualizzaSituazione(event);
	}
	catch(ex)
	{
		var msg = 'Metodo process_refresh : ' + ex.message;
		globals.ma_utl_showErrorDialog(msg)
		globals.ma_utl_logError(msg,LOGGINGLEVEL.ERROR);
	}
	finally
	{
		plugins.busy.unblock();
	}
}

/**
 * @return {Boolean}
 * 
 * @properties={typeid:24,uuid:"571B7173-E452-483D-88DD-C022A782EBC4"}
 */
function validaDate()
{
	if (vDal && vAl)
	{
		if(vDal <= vAl)
		{
			var numGiorni = Math.floor((vAl - vDal)/86400000) + 1;
			if(numGiorni > 45)
				globals.ma_utl_showWarningDialog('Per motivi di visualizzazione, il periodo non può superare i 45 giorni','Visualizzazione copertura');
			else 
				return true;
		}else
			globals.ma_utl_showWarningDialog('La data di inizio visualizzazione non può superare la data di fine','Visualizzazione copertura');
	}
	else
		globals.ma_utl_showWarningDialog('Inserire le date di inizio e fine visualizzazione','Visualizzazione copertura');
		
	return false;
}

/**
 * @properties={typeid:24,uuid:"6434BC94-727D-4E51-9445-849807497C18"}
 */
function validaParametri()
{
	if(vChkSingolaDitta && vIdDitta == -1)
	{
		globals.ma_utl_showWarningDialog('Specificare la ditta su cui filtrare','Visualizzazione copertura');
	    return false;
	}
	else if(vChkSedeDiLavoro && !(vIdSede || vArrIdSede))
	{
		globals.ma_utl_showWarningDialog('Specificare la/e sede/i di lavoro su cui filtrare','Visualizzazione copertura');
		return false;
	}
	else if(vChkCentroDiCosto && !(vCodCentroDiCosto || vArrCodCentroDiCosto))
	{
		globals.ma_utl_showWarningDialog('Specificare il/i centro/i di costo su cui filtrare','Visualizzazione copertura');
		return false;
	}
	
	return true;
}

/**
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"6BFC08A6-9F97-4D58-94D2-CD508FDEB2A9"}
 */
function goToEditVisualizzaSituazione(event) {
	
	elements.btn_refresh.enabled = true;
	elements.btn_annulla.enabled = true;
	elements.btn_edit_visualizza_situazione.enabled = false;
    elements.btn_calendar_dal.enabled = true;
    elements.btn_calendar_al.enabled = true;
    elements.fld_dal.editable = true;
    elements.fld_al.editable = true;
    
    if(elements.chk_gruppo)
       	elements.chk_gruppo.enabled = true;
    
    if(elements.chk_sede)
    {
    	elements.chk_sede.enabled = true;
	    elements.btn_lkp_sede.enabled = false;
    }
    if(elements.chk_centro_di_costo)
    {
    	elements.chk_centro_di_costo.enabled = true;
	    elements.btn_lkp_centro_di_costo.enabled = false;
    }
    if(elements.chk_solo_ditta)
    {
	    elements.chk_solo_ditta.enabled = true;
//	    if(elements.btn_lkp_ditta)
//	    	elements.btn_lkp_ditta.enabled = false;
//	    elements.fld_ditta.enabled = false;
    }
    
    if(elements.chk_dipendente)
    {
    	elements.chk_dipendente.enabled = true;
//    	elements.chk_dipendente.enabled = 
//    		elements.lbl_dipendente.enabled = 
//    			elements.fld_dipendente.enabled = true;
    }
    
    if(elements.chk_tipologia_richiesta)
       elements.chk_tipologia_richiesta.enabled = true;	
    if(elements.fld_tipo_richiesta)
    	elements.fld_tipo_richiesta.enabled = false;
	if(elements.chk_gruppo_fascia)
		elements.chk_gruppo_fascia.enabled = true;
	if(elements.fld_gruppo_fascia)
		elements.fld_gruppo_fascia.enabled = false;
		
	onDataChangeChkSoloDitta(vChkSingolaDitta,vChkSingolaDitta,event);
    onDataChangeChkCdc(vChkCentroDiCosto,vChkCentroDiCosto,event);
    onDataChangeChkGruppo(vChkGruppo,vChkGruppo,event);
    onDataChangeChkSede(vChkSedeDiLavoro,vChkSedeDiLavoro,event);
    onDataChangeFasceOrarie(vChkGruppoFasce,vChkGruppoFasce,event);
    
    globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
    
}

/**
 * @param {JSEvent} event
 *
 * @properties={typeid:24,uuid:"AB369FDB-B07E-45FD-8EC8-045F6A06A767"}
 */
function goToBrowseVisualizzaSituazione(event) {
	
	elements.btn_refresh.enabled = false;
	elements.btn_annulla.enabled = false;
    elements.btn_edit_visualizza_situazione.enabled = true;
    elements.btn_calendar_dal.enabled = false;
    elements.btn_calendar_al.enabled = false;
    elements.fld_dal.editable = false;
    elements.fld_al.editable = false;
    
    if(elements.chk_gruppo)
    {
    	elements.chk_gruppo.enabled = false;
    	elements.fld_gruppo.enabled = false;
    }
    
    if(elements.chk_sede)
    {
    	elements.chk_sede.enabled = false;
    	elements.btn_lkp_sede.enabled = false;
    }
    
    if(elements.chk_centro_di_costo)
    {
    	elements.chk_centro_di_costo.enabled = false;
    	elements.btn_lkp_centro_di_costo.enabled = false;
    }
        
    if(elements.chk_solo_ditta)
    {
       elements.chk_solo_ditta.enabled = false;
       elements.fld_ditta.enabled = false;
       if(elements.btn_lkp_ditta)
    	   elements.btn_lkp_ditta.enabled = false;
    }
    if(elements.chk_tipologia_richiesta)
    {
    	elements.chk_tipologia_richiesta.enabled = true;
    	elements.fld_tipo_richiesta.enabled = false;
    }
    if(elements.chk_gruppo_fascia)
    {
    	elements.chk_gruppo_fascia.enabled = true;
    	elements.fld_gruppo_fascia.enabled = false;
    }
    
    globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
    
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"3C14A031-6EDC-4D7D-8F90-3EF92DCE5376"}
 */
function onActionAnnulla(event) 
{
	getLastSelection(event);
	goToBrowseVisualizzaSituazione(event);
}


/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"9EDF21B5-D712-42F1-A430-6101378C942D"}
 */
function onDataChangeChkGruppo(oldValue, newValue, event) {
		
	if(elements.btn_lkp_gruppo)
		elements.btn_lkp_gruppo.enabled = newValue;
	if(elements.fld_gruppo)
		elements.fld_gruppo.enabled = newValue; 
	
	if(!newValue)
	{
		vArrGroupId = [];
		vGroupId = -1;
		vGroup = '';
	}
	
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"06361886-EFEB-4D7C-99C4-90C727186E79"}
 */
function onDataChangeChkCdc(oldValue, newValue, event) {
	
	if(elements.btn_lkp_centro_di_costo)
		elements.btn_lkp_centro_di_costo.enabled = newValue;
	if(elements.fld_centro_di_costo)
		elements.fld_centro_di_costo.enabled = newValue;
	
//	if(newValue && vIdDitta == -1)
//	{
//		globals.ma_utl_showWarningDialog('Selezionare prima la ditta per la quale filtrare i centri di costo','Visualizza copertura');
//		newValue = 0;
//	}
//	else
//	{		
		if(!newValue)
		{
			vCodCentroDiCosto = '';
			vArrCodCentroDiCosto = [];
			vCentroDiCosto = '';
		}
//	}
	
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"04F3569E-1B1F-4089-B708-5952AAA9E919"}
 */
function onDataChangeChkSede(oldValue, newValue, event) 
{
	if(elements.btn_lkp_sede)
	   elements.btn_lkp_sede.enabled = newValue;
	if(elements.fld_sede)
		elements.fld_sede.enabled = newValue;
	
	if(newValue && vIdDitta == -1)
	{
		globals.ma_utl_showWarningDialog('Selezionare prima la ditta per la quale filtrare le sedi di lavoro','Visualizza copertura');
		newValue = 0;
	}
	else
	{
		if(!newValue)
		{
			vIdSede = -1;
			vArrIdSede = [];
			vSede = '';
		}
	}
	
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
	return true;
}

/**
 * @param {JSFoundset} fs
 *
 * @properties={typeid:24,uuid:"BDD42D0A-23A5-4947-91FF-6B7A491FEADA"}
 * @AllowToRunInFind
 */
function FiltraCdc(fs)
{
	var idDittaClassificazione = null;
	
	/** @type {JSFoundSet<db:/ma_anagrafiche/ditte_classificazioni>}*/
	var fsCl = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,'ditte_classificazioni');
	if(fsCl.find())
	{
		if(vChkCentroDiCosto && vIdDitta)
	       fsCl.idditta = vIdDitta;
 	    fsCl.descrizione = 'Centro di costo';
        if(fsCl.search())
        {
        	idDittaClassificazione = fsCl.iddittaclassificazione;
        	fs.addFoundSetFilterParam('iddittaclassificazione','=',idDittaClassificazione);
        	fs.loadAllRecords();
        }
	}
	
	return fs;
}

/**
 * @param {JSFoundSet} fs
 *
 * @properties={typeid:24,uuid:"AF2DABAE-EA16-4BBF-918C-2C091DB60ACD"}
 */
function FiltraGruppiUtenti(fs)
{
	var arrGruppi = application.getValueListItems('vls_ma_sec_groups').getColumnAsArray(2);
	fs.addFoundSetFilterParam('group_id','IN',arrGruppi);
	
	return fs;
}

/**
 * @param {Array<JSRecord>} recs
 *
 * @properties={typeid:24,uuid:"C688758A-2F24-47C7-957E-B9C4134F1E31"}
 */
function AggiornaGruppiUtentiMulti(recs)
{
	vArrGroupId = recs;
	if(recs.length == 1)
		vGroup = globals.getGroupName(vArrGroupId[0]);
	else
		vGroup = 'Più gruppi selezionati';
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"3041E202-F080-4F6F-B7BA-77C6109FA740"}
 */
function onDataChangeChkSoloDitta(oldValue, newValue, event)
{
	var enabled = false;
	
	if(elements.fld_ditta)
		elements.fld_ditta.enabled = newValue;
	if(elements.btn_lkp_ditta)
		elements.btn_lkp_ditta.enabled = newValue;
	
	if(!newValue)
	{
		vIdDitta = -1;
		vDitta = '';
		// pulisci eventuale riferimento alla sede su cui filtrare
		vChkSedeDiLavoro = 0;
		vIdSede = -1;
		vArrIdSede = [];
		vSede = '';
		
		// pulisci eventuale centro di costo su cui filtrare
//		vChkCentroDiCosto = 0;
//		vCentroDiCosto = '';
//		vCodCentroDiCosto = null;
//		vArrCodCentroDiCosto = [];
				
		// pulisci eventuale dipendente precedentemente selezionato
		vChkDip = 0;
		vIdDip = -1;
		vDip = '';
		
		enabled = false;
	}
	else if(vIdDitta != -1)
		enabled = true;	
	
	if(elements.chk_sede)
		elements.chk_sede.enabled =	 enabled;
				
//	if(elements.chk_centro_di_costo)
//		elements.chk_centro_di_costo.enabled = enabled;			
	
	if(elements.chk_dipendente)
		elements.chk_dipendente.enabled = true;
							
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"6E637AB7-3111-4A61-8019-5888DCC6639A"}
 */
function onDataChangeChkDip(oldValue, newValue, event) 
{
	if(!newValue)
	{
		vIdDip = -1;
		vDip = '';
	}
	
	elements.chk_dipendente.enabled =
	elements.fld_dipendente.enabled =
		elements.btn_lkp_dipendente.enabled = newValue;
	
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
		
	return true;
}

/**
 * @param {JSFoundset} fs
 *
 * @properties={typeid:24,uuid:"1803F5B9-A9A6-4A7E-8CA5-BB1E2E335C70"}
 */
function FiltraDipendente(fs)
{
	var sqlLav = "SELECT idLavoratore FROM Lavoratori WHERE assunzione <= ? \
	              AND (cessazione IS NULL OR cessazione >= ?)";
	var arrLav = [globals.dateFormat(vAl,globals.ISO_DATEFORMAT) || globals.TODAY,globals.dateFormat(vDal,globals.ISO_DATEFORMAT) || globals.TODAY];
	
	var dsLav = databaseManager.getDataSetByQuery(globals.Server.MA_ANAGRAFICHE,sqlLav,arrLav,-1);
	
	fs.addFoundSetFilterParam('idlavoratore','IN',dsLav.getColumnAsArray(1));
	
	if(vIdDitta != -1)
	   fs.addFoundSetFilterParam('idditta','=',vIdDitta);
	
	return fs;
}

/**
 * @param {JSFoundset} fs
 *
 * @properties={typeid:24,uuid:"79D35BF6-4F7E-4EFB-AFD8-DAB6348859DA"}
 */
function FiltraSede(fs)
{
	fs.addFoundSetFilterParam('idditta','=',vIdDitta);
	fs.addFoundSetFilterParam('codtiposede','=','SO');
	return fs;
}

/**
 * @param {JSRecord} rec
 *
 * @properties={typeid:24,uuid:"761B0E41-C9BA-4DD1-A1FD-A1FBC589F376"}
 */
function AggiornaSede(rec)
{
	vIdSede = rec['iddittasede'];
	vSede = rec['descrizione'];
}

/**
 * @param {Array<JSRecord>} recs
 *
 * @properties={typeid:24,uuid:"56D1C006-DA9F-4670-BA0D-0466D0D1B49B"}
 */
function AggiornaSedeMulti(recs)
{
	vArrIdSede = recs;
	if(vArrIdSede.length == 1)
		vSede = globals.getNomeSedeDiLavoro(vArrIdSede[0]);
	else		
	    vSede = 'Più sedi selezionate';
}

/**
 * @param {JSRecord} rec
 *
 * @properties={typeid:24,uuid:"37149020-5562-4FBF-BED7-5BDDC5B5CDF2"}
 */
function AggiornaCdc(rec)
{
	vCodCentroDiCosto = rec['codice'];
	vCentroDiCosto = rec['codice'] + ' - ' + rec['descrizione'];
}

/**
 * @param {Array<JSRecord>} recs
 *
 * @properties={typeid:24,uuid:"A44DBC53-64A3-4A0E-BE04-B81A223C7C88"}
 * @AllowToRunInFind
 */
function AggiornaCdcMulti(recs)
{
	vArrCodCentroDiCosto = [];
	
	/** @type {JSFoundSet<db:/ma_anagrafiche/ditte_classificazionidettaglio>}*/
	var fsCdc = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,globals.Table.DITTE_CLASSIFICAZIONI_DETTAGLIO);
	if(fsCdc.find())
	{
		fsCdc.iddittaclassificazionedettaglio = recs;
		if(fsCdc.search())
		{
			for(var cdc = 1; cdc <= fsCdc.getSize(); cdc++)
				vArrCodCentroDiCosto.push(fsCdc.getRecord(cdc).codice);
			
		}
	}
	
	if(vArrCodCentroDiCosto.length == 0)
	{
		vArrCodCentroDiCosto = [];
		vCentroDiCosto = '';
		return;
	}
	else if(vArrCodCentroDiCosto.length == 1)
		vCentroDiCosto = fsCdc.getRecord(1).descrizione;
	else
	    vCentroDiCosto = 'Più centri di costo selezionati';
}

/** *
 * @param _firstShow
 * @param _event
 *
 * @properties={typeid:24,uuid:"28E5F28D-391A-4B10-A9C8-186736D260E3"}
 * @AllowToRunInFind
 */
function onShowForm(_firstShow, _event)
{
	_super.onShowForm(_firstShow, _event);
	
	var haRaggFasce = false;
	/** @type {JSFoundSet<db:/ma_anagrafiche/ditte_raggruppamentifasce>}*/
	var fsDitteRagg = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,globals.Table.DITTE_RAGGRUPPAMENTI_FASCE);
	if(fsDitteRagg.find())
	{
		if(fsDitteRagg.search())
			haRaggFasce = true;
	}
	
    if(_firstShow)
    {
    	vDal = null;
    	vAl = null;
    	
    	var rec;
    	
    	if(globals.ma_utl_hasModule(globals.Module.AUTORIZZAZIONI) &&
    	  (globals.ma_utl_hasKey(globals.Key.AUTORIZZAZIONI) ||
    					globals.ma_utl_hasKey(globals.Key.AUT_GERARCHIA)))
    	{
    		var y = 20;
    		
    		// allineamento centrale opzioni data
    		elements.lbl_situazione_dal.setLocation(elements.lbl_situazione_dal.getLocationX(),y);
    		elements.fld_dal.setLocation(elements.fld_dal.getLocationX(),y);
    		elements.btn_calendar_dal.setLocation(elements.btn_calendar_dal.getLocationX(),y);
    		elements.lbl_situazione_al.setLocation(elements.lbl_situazione_al.getLocationX(),y);
    		elements.fld_al.setLocation(elements.fld_al.getLocationX(),y);
    		elements.btn_calendar_al.setLocation(elements.btn_calendar_al.getLocationX(),y);
    		
    		if(globals.ma_utl_hasKey(globals.Key.AUTORIZZAZIONI) || globals.ma_utl_hasKey(globals.Key.RICHIESTA_PERMESSI_CR))
    		{
	    		elements.lbl_gruppo.visible =
	    			elements.fld_gruppo.visible =
	    				elements.chk_gruppo.visible = 
	    					elements.btn_lkp_gruppo.visible = true;
	    					
	    		// allineamento centrale opzioni gruppo		
	    		elements.lbl_gruppo.setLocation(elements.lbl_gruppo.getLocationX(),y);
	    		elements.chk_gruppo.setLocation(elements.chk_gruppo.getLocationX(),y);
	    		elements.fld_gruppo.setLocation(elements.fld_gruppo.getLocationX(),y);
	    		elements.btn_lkp_gruppo.setLocation(elements.btn_lkp_gruppo.getLocationX(),y);
	    			    					
    		}	
    		
    		if(haRaggFasce)
    		{
    			if(elements.chk_gruppo_fascia)
    			{
			    	elements.lbl_gruppo_fascia.visible =
			    		elements.chk_gruppo_fascia.visible = 
			    			elements.fld_gruppo_fascia.visible = true;
			    	// allienamento centrale opzioni fasce di raggruppamento		
	    			elements.lbl_gruppo_fascia.setLocation(elements.lbl_gruppo_fascia.getLocationX(),y);
	    			elements.chk_gruppo_fascia.setLocation(elements.chk_gruppo_fascia.getLocationX(),y);
	    			elements.fld_gruppo_fascia.setLocation(elements.fld_gruppo_fascia.getLocationX(),y);
    			}
			}
    		
			if(globals.ma_utl_hasKey(globals.Key.AUT_GESTORE))
	    	{
	    		elements.lbl_ditta.visible = 
	    			elements.fld_ditta.visible = 
	    					elements.chk_solo_ditta.visible = true;
	    			    		
//	    		rec = globals.getSingolaDitta(globals.Tipologia.STANDARD);			
//	    		if(rec)
//	    		{
//	    			vChkSingolaDitta = 1;
//	    			vIdDitta = rec.idditta;
//	    		}
	    		
				elements.lbl_gruppo.visible =
		    		elements.fld_gruppo.visible =
		    			elements.chk_gruppo.visible = 
	    	    			elements.btn_lkp_gruppo.visible = true;
		    	elements.lbl_sede.visible =
		    		elements.fld_sede.visible =
		    			elements.chk_sede.visible = 
		    				elements.btn_lkp_sede.visible = true;
		    	elements.lbl_centro_di_costo.visible =
		    		elements.fld_centro_di_costo.visible = 
		    			elements.chk_centro_di_costo.visible = 
		    				elements.btn_lkp_centro_di_costo.visible = true;
				if(haRaggFasce)
	    		{
	    			if(elements.chk_gruppo_fascia)
	    			{
				    	elements.lbl_gruppo_fascia.visible =
				    		elements.chk_gruppo_fascia.visible = 
				    			elements.fld_gruppo_fascia.visible = true;
	    			}
	    		}
				
	    		// ri-allineamento originale opzioni data
	    		elements.lbl_situazione_dal.setLocation(elements.lbl_situazione_dal.getLocationX(),10);
	    		elements.fld_dal.setLocation(elements.fld_dal.getLocationX(),10);
	    		elements.btn_calendar_dal.setLocation(elements.btn_calendar_dal.getLocationX(),10);
	    		elements.lbl_situazione_al.setLocation(elements.lbl_situazione_al.getLocationX(),10);
	    		elements.fld_al.setLocation(elements.fld_al.getLocationX(),10);
	    		elements.btn_calendar_al.setLocation(elements.btn_calendar_al.getLocationX(),10);
	    		
	    		// ri-allienamento originale opzioni fasce di raggruppamento
	    		elements.lbl_gruppo.setLocation(elements.lbl_gruppo.getLocationX(),10);
	    		elements.chk_gruppo.setLocation(elements.chk_gruppo.getLocationX(),10);
	    		elements.fld_gruppo.setLocation(elements.fld_gruppo.getLocationX(),10);
	    		elements.btn_lkp_gruppo.setLocation(elements.btn_lkp_gruppo.getLocationX(),10);
	    		
	    		// ri-allineamento originale opzioni fasce di raggruppamento		
				if(elements.lbl_gruppo_fascia)
				   elements.lbl_gruppo_fascia.setLocation(elements.lbl_gruppo_fascia.getLocationX(),34);
				if(elements.chk_gruppo_fascia)
				   elements.chk_gruppo_fascia.setLocation(elements.chk_gruppo_fascia.getLocationX(),34);
				if(elements.fld_gruppo_fascia)
				   elements.fld_gruppo_fascia.setLocation(elements.fld_gruppo_fascia.getLocationX(),34);
	    	}
       	}
       	else
       	{
       		if(globals.ma_utl_hasKey(globals.Key.RILEVAZIONE_PRESENZE))
       		{
       			elements.lbl_ditta.visible = 
    			elements.fld_ditta.visible = 
    					elements.chk_solo_ditta.visible = true;
    		
				elements.lbl_ditta.setLocation(elements.lbl_ditta.getLocationX() - 289,elements.lbl_ditta.getLocationY());			
	    		elements.chk_solo_ditta.setLocation(elements.chk_solo_ditta.getLocationX() - 289,elements.chk_solo_ditta.getLocationY());
	    		elements.fld_ditta.setLocation(elements.fld_ditta.getLocationX() - 289,elements.fld_ditta.getLocationY());
    		    		
	    		rec = globals.getSingolaDitta(globals.Tipologia.STANDARD);			
	    		if(rec)
	    		{
	    			vChkSingolaDitta = 1;
	    			vIdDitta = rec.idditta;
	    		}
	    		
		    	elements.lbl_sede.visible =
		    		elements.fld_sede.visible =
		    			elements.chk_sede.visible = 
		    				elements.btn_lkp_sede.visible = true;
		    	elements.lbl_centro_di_costo.visible =
		    		elements.fld_centro_di_costo.visible = 
		    			elements.chk_centro_di_costo.visible = 
		    				elements.btn_lkp_centro_di_costo.visible = true;

				if(haRaggFasce)
	    		{
			    	elements.lbl_gruppo_fascia.visible =
			    		elements.chk_gruppo_fascia.visible = 
			    			elements.fld_gruppo_fascia.visible = true;
	    		}
       		}
       	}
    	        	
    	if(!globals.ma_utl_hasKey(globals.Key.COMMESSE_GESTORE))
    		application.setValueListItems('vls_tipi_visualizzazione_copertura',new Array('Assenze','Fasce orarie/turni','Eventi'),new Array(1,2,3));
    	
    }
     
    // visualizzazione raggruppamenti fasce orarie
    if(haRaggFasce)
       setFasceOrarieValueList(_event);
       
    forms.giorn_visualizza_copertura_legenda.elements.lbl_color_5.visible =
    forms.giorn_visualizza_copertura_legenda.elements.lbl_text_5.visible = haRaggFasce;
}

/**
 * @param {JSEvent} event
 * 
 * @properties={typeid:24,uuid:"BFE35F2F-5192-49D7-BD1B-453FEF9DEA5E"}
 */
function getLastSelection(event)
{
	// centro di costo
	vChkCentroDiCosto = vLastSelection.chk_centro_costo_id;
	vCodCentroDiCosto = vLastSelection.centro_costo_id;
	vCentroDiCosto = vLastSelection.centro_costo_nome;
	onDataChangeChkCdc(vChkCentroDiCosto,vChkCentroDiCosto,event);
	
	// gruppo
	vChkGruppo = vLastSelection.chk_group_id;
	vGroupId = vLastSelection.group_id;
	onDataChangeChkGruppo(vChkGruppo,vChkGruppo,event);
	
	// sede di lavoro
	vChkSedeDiLavoro = vLastSelection.chk_sede_id;
	vIdSede = vLastSelection.sede_id;
	vSede = vLastSelection.sede_nome;
	onDataChangeChkSede(vChkSedeDiLavoro,vChkSedeDiLavoro,event);
	
	// altre opzioni
	vChkDettaglioEvento = vLastSelection.dettaglio_eventi;
	vSoloDipConRichieste = vLastSelection.solo_richieste;
}

/**
 * @param {JSEvent} event
 * @properties={typeid:24,uuid:"64FEF404-5092-426A-BB27-FE90439B3C03"}
 */
function setLastSelection(event)
{
	// centro di costo
	vLastSelection.chk_centro_costo_id = vChkCentroDiCosto;
	vLastSelection.centro_costo_id = vCodCentroDiCosto;
	vLastSelection.centro_costo_nome = vCentroDiCosto;
	
	// gruppo
	vLastSelection.chk_group_id = vChkGruppo;
	vLastSelection.group_id = vGroupId;
	
	// sede di lavoro
	vLastSelection.chk_sede_id = vChkSedeDiLavoro;
	vLastSelection.sede_id = vIdSede;
	vLastSelection.sede_nome = vSede;
	
	// altre opzioni
	vLastSelection.dettaglio_eventi = vChkDettaglioEvento;
	vLastSelection.solo_richieste = vSoloDipConRichieste;

}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"8EA19C6B-B1EB-42EB-9D5B-926D4253F57E"}
 */
function onDataChangeTipoVisualizzazione(oldValue, newValue, event) 
{
	if(newValue == 1)
		elements.chk_tipologia_richiesta.visible = 
			elements.lbl_solo_dip_con_richieste.visible = 
				elements.fld_tipo_richiesta.visible = true;
	else
		elements.chk_tipologia_richiesta.visible = 
			elements.lbl_solo_dip_con_richieste.visible = 
				elements.fld_tipo_richiesta.visible = false;
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"900427CF-FBE0-4248-805C-94036E44D7DE"}
 */
function onDataChangeSingolaDitta(oldValue, newValue, event) 
{
	// pulisci eventuale riferimento alla sede su cui filtrare
	vIdSede = -1;
	vArrIdSede = [];
	vSede = '';
	elements.btn_lkp_sede.enabled = false;
	
	// pulisci eventuale centro di costo su cui filtrare
	vCentroDiCosto = '';
	vCodCentroDiCosto = null;
	vArrCodCentroDiCosto = [];
	elements.btn_lkp_centro_di_costo.enabled = false;
	
	onDataChangeChkSoloDitta(vChkSingolaDitta,vChkSingolaDitta,event);
		
	return true;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param rec
 *
 * @properties={typeid:24,uuid:"0E3F2210-1414-4443-B0F4-BEB041061204"}
 */
function AggiornaSingolaDitta(rec)
{
	vIdDitta = rec['idditta'];
	vDitta = rec['ragionesociale'];
	
	// aggiorna stato sedi di lavoro 
	vChkSedeDiLavoro = 0;
	vIdSede = -1;
	vSede = '';
	elements.btn_lkp_sede.enabled = false;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param rec
 *
 * @properties={typeid:24,uuid:"ADDC9A35-3C75-4C0F-B2AE-C3CADB23209C"}
 */
function AggiornaDipendente(rec)
{
	vIdDip = rec['idlavoratore'];
	vDip = rec['nominativo'] || rec['lavoratori_to_lavoratori_personeesterne.nominativo'];
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"1BC6E34B-F6E5-4E2B-810F-5472170BB605"}
 */
function onDataChangeTipoRichiesta(oldValue, newValue, event) 
{
	elements.fld_tipo_richiesta.enabled = newValue;
	if(!newValue)
		vIdDitta = -1;
	return true;
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"BB94D04D-5D23-4ED6-9411-531DCAA8BC69"}
 */
function onDataChangeFasceOrarie(oldValue, newValue, event) 
{
	if(elements.fld_gruppo_fascia)
	   elements.fld_gruppo_fascia.enabled = newValue;
	if(!newValue)
		vIdGruppoFasce = -1;
	
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
	return true;
}

/**
 * TODO generated, please specify type and doc for the params
 * @param event
 *
 * @properties={typeid:24,uuid:"F85DB72F-8F8B-40B7-99EB-FC7A61CE35E7"}
 */
function setFasceOrarieValueList(event)
{
	var realValues = new Array();
	var displayValues = new Array();
	
	var sql = "SELECT \
	             DRF.idDittaRaggruppamentoFascia \
				,DRF.Codice \
				,DRF.Descrizione \
				,DRF.RaggruppamentoDefault \
				,D.Codice \
				FROM Ditte_RaggruppamentiFasce DRF \
				INNER JOIN Ditte D \
				ON DRF.idDitta = D.idDitta"
	
	var dsFasceOrarie = databaseManager.getDataSetByQuery(globals.Server.MA_ANAGRAFICHE,sql,null,-1);
	if (dsFasceOrarie && dsFasceOrarie.getMaxRowIndex() > 0)
	{
		realValues[0] = null;
		displayValues[0] = '';
		
		for(var f = 1; f <= dsFasceOrarie.getMaxRowIndex(); f++)
		{
			realValues.push(dsFasceOrarie.getValue(f,1));
			displayValues.push(dsFasceOrarie.getValue(f,5) + ' - ' 
				                                 + dsFasceOrarie.getValue(f,2) + ' - '
												 + dsFasceOrarie.getValue(f,3));
		}
	}
	else
		vIdGruppoFasce = null;
	
	application.setValueListItems('vls_gruppi_fasce_orarie', displayValues, realValues);
	
}

