// CAMPI AUSILIARI

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"0BAEF5F7-7D1F-4058-A7F1-9FDC56A4D9BC",variableType:93}
 */
var vDateTo = null;

// CAMPI DI FILTRAGGIO

/**
 * @properties={typeid:35,uuid:"F97FCE58-7002-427A-85B6-6049E129F854",variableType:-4}
 */
var vContratto = null;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"2838AE44-420A-4F21-BC5E-4B9978382B33"}
 */
var vContrattoString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"9B8AC3B8-0161-45CC-845B-A26F22FA7C9F",variableType:4}
 */
var vFilterContratto = 0;

/**
 * @properties={typeid:35,uuid:"CD5A1D78-F4C2-4E6D-B009-F5B79C3B2104",variableType:-4}
 */
var vQualifica = null;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"DF88657A-7541-46BC-B592-1748C6FDCEEF"}
 */
var vQualificaString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"ECC05527-33DA-40F9-8D38-F3AA73F939A5",variableType:4}
 */
var vFilterQualifica = 0;

/**
 * @properties={typeid:35,uuid:"CC4D2CEC-3267-4CCD-A2FA-931C2FE76D84",variableType:-4}
 */
var vPosizioniInps = null;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F0FCD0E9-4FD5-4ED6-8FAA-54037D76A4B7"}
 */
var vPosizioneInpsString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D3A5360C-7C68-4B7B-9F40-39D27AD58694",variableType:4}
 */
var vFilterPosizioneInps = 0;

/**
 * @properties={typeid:35,uuid:"4E317D07-E34F-4DE7-847A-E93871FFFEDB",variableType:-4}
 */
var vSediLavoro = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6FD59D39-348E-4817-9986-C481FAFFE748"}
 */
var vSediLavoroString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4C0057C1-272F-4CF4-9BFF-364B60282F4E",variableType:4}
 */
var vFilterGroupLavoratori = 0;

/**
 * @properties={typeid:35,uuid:"CA029EE3-867D-4F9B-9798-56FDACB81A49",variableType:-4}
 */
var vGroupLavoratori = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"1260538C-0A13-41EE-A22C-FB4D3A7B4EFA"}
 */
var vGroupLavoratoriString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"FFC43244-E035-4B4E-A470-3C91FB7B686B",variableType:4}
 */
var vFilterSedeLavoro = 0;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"C1CE91B7-FD46-46A8-9547-F3E94BB88BBB"}
 */
var vRaggruppamento = null;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"86A10DA5-D322-4871-AC34-D99231CD65DA",variableType:4}
 */
var vRaggruppamentoCodice = 0;

/**
 * @properties={typeid:35,uuid:"1865F06F-BF16-4FC7-A3C0-74B299593F6A",variableType:-4}
 */
var vRaggruppamentoTipoCampo = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3A7125CC-398D-494C-A898-EDB0E74B6602"}
 */
var vRaggruppamentoString = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A9E17AB3-E758-4950-BE36-F3B29477B201",variableType:4}
 */
var vFilterRaggruppamento = 0;

/**
 * @properties={typeid:35,uuid:"561AFAD0-25C4-4918-A4D3-ACEEB2ADD19A",variableType:-4}
 */
var vRaggruppamentiDettaglio = null;
/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"BAE6D062-BD9F-4D6D-BBCD-11BEE4B2016B"}
 */
var vRaggruppamentiDettaglioString = '';

/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"A05CF6D6-AFF6-4592-B77C-E0EF24043421",variableType:-4}
 */
var vGroupContratto = false;
/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"0A23EC41-BAD2-432D-BB64-71A591159BFF",variableType:-4}
 */
var vGroupQualifica = false;
/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"ED4175E4-7C5F-4871-AA11-86C2E58C653C",variableType:-4}
 */
var vGroupPosizioneinps = false;
/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"CA1E9753-82A9-444C-9E2F-34963179A8F5",variableType:-4}
 */
var vGroupSedelavoro = false;
/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"E8A1141A-F444-4D3F-B037-D2EE6458178E",variableType:-4}
 */
var vGroupRaggruppamento = false;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"92CD7F5A-0EF4-4ADC-9AF9-FD10E59E1FD7",variableType:4}
 */
var vGroupTiporaggruppamento = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"82CB3226-B463-4DDB-A795-0F2027B334D0",variableType:4}
 */
var vIdDittaClassificazione = -1;
/**
 * @param {JSEvent} event
 * @param {Number} oldValue
 * @param {Number} newValue
 * 
 * @private
 *
 * @properties={typeid:24,uuid:"791C689A-4C2D-480B-828D-A5F5073C6F91"}
 */
function onDataChangeFilter(oldValue, newValue, event) 
{
	/**
	 * 1. Recupera il nome dell'elemento su cui filtrare
	 */
	var elementName = event.getElementName();
	if(!elementName)
		return false;
	
	var splitName = elementName.split('_')[1];
	updateStatus(splitName, newValue);
	
//	if(!newValue)
//		reset(splitName[0].toUpperCase() + splitName.slice(1, splitName.length));
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"F12300AB-A585-4F71-870B-8D494085E42D"}
 */
function onDataChangeRaggruppamento(oldValue, newValue, event)
{
	vRaggruppamentiDettaglioString = '';
	
	elements.fld_raggruppamento.enabled = newValue;
	//elements.chk_group_raggruppamento.enabled = newValue;
	
	if(!newValue)
		vRaggruppamentiDettaglio = null;
	else
	{
		var realValues = new Array();
		var displayValues = new Array();
		
		var ds = globals.getClassificazioniDitta(idditta);
		if(ds && ds.getMaxRowIndex())
		{
			for(var r = 1; r <= ds.getMaxRowIndex(); r++)
			{
				// iddittaclassificazione
				realValues.push(ds.getValue(r,1) + ' ' + ds.getValue(r,2));
				// codice + ' - ' + descrizione
				displayValues.push(ds.getValue(r,2) + ' - ' + ds.getValue(r,3))
			}
		}		
		application.setValueListItems('vls_raggruppamenti',displayValues,realValues);
	}
	return onDataChangeFilter(oldValue, newValue, event);
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"6E4EC0A3-5B7E-42F2-884C-89FEB5C4C450"}
 */
function onDataChangeRaggruppamentoDettaglio(oldValue, newValue, event)
{
	var split = newValue.split(" ");
//	vRaggruppamentoTipoCampo = split[0];
    vRaggruppamentoCodice = split[1];
    vIdDittaClassificazione = split[0];
	
    vRaggruppamentiDettaglioString = '';
	reset('vRaggruppamentiDettaglio');
	return true;
}

/**
 * @param {String} name
 * @param {Number} status
 *
 * @properties={typeid:24,uuid:"F4D3FDF6-E2D1-487B-9B42-89EBEB3AA157"}
 */
function updateStatus(name, status)
{
	/**
	 * 2. Abilita/Disabilita il pulsante corrispondente
	 */
	var btnName = ['btn', name].join('_');
	elements[btnName] && (elements[btnName].enabled = status);
	
	/**
	 * 3. Abilita/Disabilita il checkbox di ordinamento corrispondente
	 */
	var orderName = ['chk', name, 'ordine'].join('_');
	elements[orderName] && (elements[orderName].enabled = status);
}

/**
 * @param {String} name
 *
 * @properties={typeid:24,uuid:"09FCBCB7-BC08-4C5D-B62D-95C2EE4C7779"}
 */
function reset(name)
{
	var form = forms[controller.getName()];
	var variableName = ['v', name].join('');
	
	if(form && null !== form[variableName])
		form[variableName] = null;
	
	var stringVariableName = ['v', name, 'String'].join('');
	if(form && null !== form[stringVariableName])
		form[stringVariableName] = null;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_contratti>} fs
 *
 * @properties={typeid:24,uuid:"39BBE860-B734-4DE3-8AEB-189E9EB78E57"}
 */
function filterContratto(fs)
{
	return filter(fs, 'SELECT idGruppoContrattuale FROM [dbo].[F_Ditta_Contratti_Al](?,?)', [idditta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_presenze/e2tabqualifiche>} fs
 *
 * @properties={typeid:24,uuid:"2852D726-94EA-4BF1-96E5-2B1C7CB9CAF8"}
 */
function filterQualifica(fs)
{
	return filter(fs, 'SELECT idTabQualifiche FROM [dbo].[F_Ditta_Qualifiche_Al](?,?)', [idditta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_inps>} fs
 *
 * @properties={typeid:24,uuid:"C84F1E9A-AE7A-44E4-B7E0-EB587F2D898C"}
 */
function filterPosizioneInps(fs)
{
	return filter(fs, 'SELECT idDittaInps FROM [dbo].[F_Ditta_PosizioneInps_Al](?,?)', [idditta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_sedi>} fs
 *
 * @properties={typeid:24,uuid:"4B13D2BC-FCE3-499A-821F-B4275CD89B53"}
 */
function filterSedeLavoro(fs)
{
	fs = filter(fs, 'SELECT idDittaSede FROM [dbo].[F_Ditta_Sedi_Al](?,?)', [idditta, vDateTo]);
	fs.addFoundSetFilterParam('codtiposede', globals.ComparisonOperator.EQ, globals.codSEDEOPERATIVA);
	
	return fs;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_presenzegruppigestione>} fs
 *
 * @properties={typeid:24,uuid:"B4D7AE72-BF72-4341-9D44-2C82633C88B9"}
 */
function filterGruppiLavoratori(fs)
{
	fs.addFoundSetFilterParam('idditta','=',idditta);
	return fs;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/v_ditte_raggruppamenti_dettaglio>} fs
 *
 * @properties={typeid:24,uuid:"CCBA71B9-8322-4C14-98EE-4BE397532AD6"}
 */
function filterRaggruppamento(fs)
{
	if(vRaggruppamentoTipoCampo == null)
	{
		globals.ma_utl_showWarningDialog('Selezionare un tipo di raggruppamento','Filtri anagrafici per stampa');
	    return null;
	}
	
	return filter(fs
		          , 'SELECT idDettaglio FROM [dbo].[F_Ditta_Raggruppamenti_Al](?,?,?)'
				  , [idditta, vDateTo, vRaggruppamentoTipoCampo]);
}

/**
 * @param {JSFoundSet<db:/ma_anagrafiche/ditte_classificazioni>} fs
 * 
 * @return {JSFoundSet}
 *
 * @properties={typeid:24,uuid:"573A6A41-D826-4D6E-AA22-22604EBD95B3"}
 */
function filterRaggruppamentoDettaglio(fs)
{
	fs.addFoundSetFilterParam('iddittaclassificazione','IN',vIdDittaClassificazione);
	return fs;
	
//	return filter(fs
//		          , 'SELECT idDettaglio FROM [dbo].[F_Ditta_Raggruppamenti_Al](?,?,?)'
//				  , [vIdDitta, vDateTo, vRaggruppamentoTipoCampo]);
}

/**
 * @properties={typeid:24,uuid:"941B7272-62E2-4A80-880D-AE06684B83D3"}
 */
function filter(fs, sql, args)
{
	var table = databaseManager.getTable(fs);
	if (!table)
		throw 'Table not found for datasource: ' + fs.getDataSource();
	
	var pkName = table.getRowIdentifierColumnNames()[0];
	
	var ds = databaseManager.getDataSetByQuery(globals.Server.MA_ANAGRAFICHE, sql, args, -1);
	if(ds.getMaxRowIndex() > 0)
		fs.addFoundSetFilterParam(pkName, 'IN', ds.getColumnAsArray(1));
	
	return fs;
}

/**
 * @param {Array<JSRecord<db:/ma_presenze/e2tabgruppicontrattuali>>} records
 *
 * @properties={typeid:24,uuid:"A128E631-0278-4E38-B844-13F008ACC639"}
 */
function updateContratto(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.radicecontratto + ' - ' + record.descrizione);
			}
		);
		
		vContrattoString = temp.join('\n');
		vContratto = records.map(function(record){ return record.radicecontratto; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_presenze/e2tabqualifiche>>} records
 *
 * @properties={typeid:24,uuid:"633EB50D-265B-4156-976B-2A41CCF6FFAA"}
 */
function updateQualifica(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.radicequalifica + ' - ' + record.descrizione);
			}
		);
		
		vQualificaString = temp.join('\n');
		vQualifica = records.map(function(record){ return record.radicequalifica; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/ditte_inps>>} records
 *
 * @properties={typeid:24,uuid:"E90E243E-597F-4018-A551-454307086124"}
 */
function updatePosizioneInps(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.posizioneinps + ' - ' + record.ditte_inps_to_ditte_attivita.descrizioneateco);
			}
		);
		
		vPosizioneInpsString = temp.join('\n');
		vPosizioniInps = records.map(function(record){ return record.posizioneinps; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/ditte_sedi>>} records
 *
 * @properties={typeid:24,uuid:"7D58C3F0-C2D2-43DE-9F29-D4F4361CDC15"}
 */
function updateSedeLavoro(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.codice + ' - ' + record.descrizione);
			}
		);
		
		vSediLavoroString = temp.join('\n');
		vSediLavoro = records.map(function(record){ return record.iddittasede; });
	}
}

/**
 * @param {JSRecord<db:/ma_anagrafiche/ditte_presenzegruppigestione>} record
 *
 * @properties={typeid:24,uuid:"8923169D-A1CC-4E3B-B0DE-312D5C79346C"}
 */
function updateGruppoLavoratori(record)
{
	if(record)
	{
		vGroupLavoratoriString = record.codice + ' - ' + record.descrizione;
		vGroupLavoratori = record.codice; 
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/v_ditte_raggruppamenti_dettaglio>>} records
 *
 * @properties={typeid:24,uuid:"AE7917A4-E403-44DD-8559-3FC384C42B1E"}
 */
function updateRaggruppamentoDettaglio(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.codice + ' - ' + record.descrizione);
			}
		);
		
		vRaggruppamentiDettaglioString = temp.join('\n');
		vRaggruppamentiDettaglio = records.map(function(record){ return record.codice; });
	}
}

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"42E81847-B570-4238-A5C3-FA6B591BCC01"}
 */
function onShowForm(firstShow, event)
{
	vDateTo = globals.TODAY;
    resetAll();
	
	foundset.removeFoundSetFilterParam('ftr_idditta');
    foundset.addFoundSetFilterParam('idditta','=',forms.giorn_header.idditta,'ftr_idditta');
    foundset.loadAllRecords();
}

/**
 * @properties={typeid:24,uuid:"5337A3FE-44A3-4098-B601-1EEE54D63022"}
 */
function resetAll()
{
	globals.resetAll(controller.getName());
	
	var jsForm = solutionModel.getForm(controller.getName());
	var lbls = jsForm.getLabels();
	for(var label in lbls)
	{
		if(elements[lbls[label].name])
			elements[lbls[label].name].enabled = false;
	}
}

/**
 * @properties={typeid:24,uuid:"44D6913A-A57E-42C5-9955-ED15938C1EB6"}
 */
function filterLavoratori(fs)
{
	fs.addFoundSetFilterParam('idditta', globals.ComparisonOperator.EQ, idditta);
	
	/**
	 * Filtri anagrafici
	 */
	if(forms.stampa_filtri_anagrafici.vFilterContratto)
		fs.addFoundSetFilterParam('codcontratto', 'IN', vContratto);
	
	if(forms.stampa_filtri_anagrafici.vFilterQualifica)
		fs.addFoundSetFilterParam('codqualifica', 'IN', vQualifica);
	
	if(forms.stampa_filtri_anagrafici.vFilterPosizioneInps)
		fs.addFoundSetFilterParam('posizioneinps', 'IN', vPosizioniInps);
	
	if(forms.stampa_filtri_anagrafici.vFilterRaggruppamento)
		fs.addFoundSetFilterParam('lavoratori_to_lavoratori_classificazioni.codtipoclassificazione', globals.ComparisonOperator.EQ, vRaggruppamento);
	
	if(forms.stampa_filtri_anagrafici.vRaggruppamentiDettaglio)
		fs.addFoundSetFilterParam('lavoratori_to_lavoratori_classificazioni.codclassificazione', 'IN', vRaggruppamentiDettaglio);
	
	// TODO aggiunta campo filtro per gruppi lavoratori
	
	return fs;
}

/**
 * @properties={typeid:24,uuid:"281421AD-483F-441C-AC0F-EB060C967FDE"}
 */
function gotoBrowse()
{
	elements.fld_raggruppamento.enabled = false;
	elements.btn_raggruppamento.enabled = false;
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"89682543-48C3-4D4A-A16F-A909066A64A0"}
 */
function onDataChangeGruppoLavoratori(oldValue, newValue, event) 
{
    if(!newValue)
    {
    	vGroupLavoratori = '';
    	vGroupLavoratoriString = '';
    	elements.btn_gruppo_lavoratori.enabled = false;
    }
    else
    	elements.btn_gruppo_lavoratori.enabled = true;
    
	return true
}
