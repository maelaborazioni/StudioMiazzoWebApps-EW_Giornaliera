/**
 * @properties={typeid:35,uuid:"4C6C58DA-E250-4B13-908A-EC27CDC6FA41",variableType:-4}
 */
var vContratto = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"79D0D226-19F6-4614-BE9F-45DEB6E77B7A"}
 */
var vContrattoString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"26EBC461-657A-43AA-A347-42E5D0103FA0"}
 */
var vContrattoStringText = '';

/**
 * @properties={typeid:35,uuid:"F86919C8-4EC5-4E54-B93A-7E5B23617D00",variableType:-4}
 */
var vGruppoLavoratori = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5D49EBF7-54B1-45A8-9F07-3A613BBCB8A0"}
 */
var vGruppoLavoratoriString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C3BD89E9-E48A-41A1-B7F6-CEFE9A73AA00"}
 */
var vGruppoLavoratoriStringText = '';

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"81141AB0-E792-431E-9908-53F90DF028FC",variableType:93}
 */
var vDateTo = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6D71B9A2-9FC7-4796-9A79-24382D33EB8E",variableType:4}
 */
var vFilterContratto = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D62B9055-CFD0-4695-9695-0E90D6BFFB2D",variableType:4}
 */
var vFilterPosizioneInps = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"2938BB76-6D06-4B1D-B779-EAE98ACD18CB",variableType:4}
 */
var vFilterQualifica = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46D360A8-CE46-4C10-B9A6-4188F8555313",variableType:4}
 */
var vFilterRaggruppamento = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"60B6A39C-7F4C-41FE-B4B0-138511A81C68",variableType:4}
 */
var vFilterSedeLavoro = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F4F1CBB1-4964-4616-A90C-7F95D3A3CCFA",variableType:4}
 */
var vFilterGruppiLavoratori = 0;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"CAEA198C-2485-4F9F-A540-BFB591A78989"}
 */
var vPosizioneInpsString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"0D0FE283-127C-4FC2-B937-99B84601A87E"}
 */
var vPosizioneInpsStringText = '';

/**
 * @properties={typeid:35,uuid:"CB7236F7-8ABD-4969-8ED6-F0468433C7A6",variableType:-4}
 */
var vPosizioniInps = null;

/**
 * @properties={typeid:35,uuid:"A72D1674-0C36-4160-8B8D-5765FC24BB50",variableType:-4}
 */
var vQualifica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"88904EA1-1D66-444E-BC2C-7578CD5A127A"}
 */
var vQualificaString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"05114A66-C310-43C4-861B-7AE96E1D5CB9"}
 */
var vQualificaStringText = '';

/**
 * @properties={typeid:35,uuid:"24B667EE-0256-4B9C-9485-419BEA6D395E",variableType:-4}
 */
var vRaggruppamentiDettaglio = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B63F750B-E913-474A-9B58-DE881C4A5EF0"}
 */
var vRaggruppamentiDettaglioString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C77EB8A1-5A7A-4CB2-AB11-7966B37D9981"}
 */
var vRaggruppamentiDettaglioStringText = '';

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"02FF2ABD-265C-4E2B-9129-995DCFF1E9BA"}
 */
var vRaggruppamento = null;
/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"27DED2F1-66E0-432A-BF01-215E5012EA5F",variableType:4}
 */
var vRaggruppamentoCodice = 0;

/**
 * @properties={typeid:35,uuid:"0F527AED-D49F-438E-BDDE-03FF3A5A2F39",variableType:-4}
 */
var vRaggruppamentoTipoCampo = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"32B42C8B-01EC-4BB3-B4CD-D2F9CD082622"}
 */
var vRaggruppamentoString = '';

/**
 * @properties={typeid:35,uuid:"65222EA5-04B6-4998-A5EC-C840DA771AE5",variableType:-4}
 */
var vSediLavoro = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6DFDB937-6D15-4BAA-866F-611D69D38615"}
 */
var vSediLavoroString = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3978E54A-CDE8-495F-8796-4C6CBCE60C25"}
 */
var vSediLavoroStringText = '';

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C4F6DCFA-E42C-43D0-94A1-15982E67C91E",variableType:4}
 */
var vIdDitta = -1;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"3B497828-790D-42D5-A15F-5587E8CB6544",variableType:4}
 */
var vIdDittaClassificazione = -1;

/**
 * @param {JSEvent} event
 * @param {Number} oldValue
 * @param {Number} newValue
 * 
 * @private
 *
 * @properties={typeid:24,uuid:"791C689A-4C2D-480B-828D-A5F5073C6F91"}
 */
function onDataChangeFilter(oldValue, newValue, event) 
{
	/**
	 * 1. Recupera il nome dell'elemento su cui filtrare
	 */
	var elementName = event.getElementName();
	if(!elementName)
		return false;
	
	var splitName = elementName.split('_')[1];
	updateStatus(splitName, newValue);
	
//	if(!newValue)
//		reset(splitName[0].toUpperCase() + splitName.slice(1, splitName.length));
	
	return true;
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"F12300AB-A585-4F71-870B-8D494085E42D"}
 */
function onDataChangeRaggruppamento(oldValue, newValue, event)
{
	vRaggruppamentiDettaglioString = '';
	
	elements.fld_raggruppamento.enabled = newValue;
	//elements.chk_group_raggruppamento.enabled = newValue;
	
	if(!newValue)
		vRaggruppamentiDettaglio = null;
	else
	{
		var realValues = new Array();
		var displayValues = new Array();
		
		var ds = globals.getRaggruppamentiDitta(idditta);
		if(ds && ds.getMaxRowIndex())
		{
			for(var r = 1; r <= ds.getMaxRowIndex(); r++)
			{
				// iddittaclassificazione
				realValues.push(ds.getValue(r,1) + ' ' + ds.getValue(r,2));
				// codice + ' - ' + descrizione
				displayValues.push(ds.getValue(r,2) + ' - ' + ds.getValue(r,3))
			}
		}		
		application.setValueListItems('vls_raggruppamenti',displayValues,realValues);
	}
	return onDataChangeFilter(oldValue, newValue, event);
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"6E4EC0A3-5B7E-42F2-884C-89FEB5C4C450"}
 */
function onDataChangeRaggruppamentoDettaglio(oldValue, newValue, event)
{
	var split = newValue.split(" ");
//	vRaggruppamentoTipoCampo = split[0];
    vRaggruppamentoCodice = split[1];
    vIdDittaClassificazione = split[0];
	
    vRaggruppamentiDettaglioString = '';
	reset('vRaggruppamentiDettaglio');
	return true;
}

/**
 * @param {String} name
 * @param {Number} status
 *
 * @properties={typeid:24,uuid:"F4D3FDF6-E2D1-487B-9B42-89EBEB3AA157"}
 */
function updateStatus(name, status)
{
	/**
	 * 2. Abilita/Disabilita il pulsante corrispondente
	 */
	var btnName = ['btn', name].join('_');
	elements[btnName] && (elements[btnName].enabled = status);
	
	/**
	 * 3. Abilita/Disabilita il checkbox di ordinamento corrispondente
	 */
	var orderName = ['chk', name, 'ordine'].join('_');
	elements[orderName] && (elements[orderName].enabled = status);
}

/**
 * @param {String} name
 *
 * @properties={typeid:24,uuid:"09FCBCB7-BC08-4C5D-B62D-95C2EE4C7779"}
 */
function reset(name)
{
	var form = forms[controller.getName()];
	var variableName = ['v', name].join('');
	
	if(form && null !== form[variableName])
		form[variableName] = null;
	
	var stringVariableName = ['v', name, 'String'].join('');
	if(form && null !== form[stringVariableName])
		form[stringVariableName] = null;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_contratti>} fs
 *
 * @properties={typeid:24,uuid:"39BBE860-B734-4DE3-8AEB-189E9EB78E57"}
 */
function filterContratto(fs)
{
	return filter(fs, 'SELECT idGruppoContrattuale FROM [dbo].[F_Ditta_Contratti_Al](?,?)', [vIdDitta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_presenze/e2tabqualifiche>} fs
 *
 * @properties={typeid:24,uuid:"2852D726-94EA-4BF1-96E5-2B1C7CB9CAF8"}
 */
function filterQualifica(fs)
{
	return filter(fs, 'SELECT idTabQualifiche FROM [dbo].[F_Ditta_Qualifiche_Al](?,?)', [vIdDitta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_inps>} fs
 *
 * @properties={typeid:24,uuid:"C84F1E9A-AE7A-44E4-B7E0-EB587F2D898C"}
 */
function filterPosizioneInps(fs)
{
	return filter(fs, 'SELECT idDittaInps FROM [dbo].[F_Ditta_PosizioneInps_Al](?,?)', [vIdDitta, vDateTo]);
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_sedi>} fs
 *
 * @properties={typeid:24,uuid:"4B13D2BC-FCE3-499A-821F-B4275CD89B53"}
 */
function filterSedeLavoro(fs)
{
	fs = filter(fs, 'SELECT idDittaSede FROM [dbo].[F_Ditta_Sedi_Al](?,?)', [vIdDitta, vDateTo]);
	fs.addFoundSetFilterParam('codtiposede', globals.ComparisonOperator.EQ, globals.codSEDEOPERATIVA);
	
	return fs;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/ditte_presenzegruppigestione>} fs
 *
 * @properties={typeid:24,uuid:"B4D7AE72-BF72-4341-9D44-2C82633C88B9"}
 */
function filterGruppiLavoratori(fs)
{
	fs.addFoundSetFilterParam('idditta','=',vIdDitta);
	return fs;
}

/**
 * @param {JSFoundset<db:/ma_anagrafiche/v_ditte_raggruppamenti_dettaglio>} fs
 *
 * @properties={typeid:24,uuid:"CCBA71B9-8322-4C14-98EE-4BE397532AD6"}
 */
function filterRaggruppamento(fs)
{
	if(vRaggruppamentoTipoCampo == null)
	{
		globals.ma_utl_showWarningDialog('Selezionare un tipo di raggruppamento','Filtri anagrafici per stampa');
	    return null;
	}
	
	return filter(fs
		          , 'SELECT idDettaglio FROM [dbo].[F_Ditta_Raggruppamenti_Al](?,?,?)'
				  , [vIdDitta, vDateTo, vRaggruppamentoTipoCampo]);
}

/**
 * @param {JSFoundSet<db:/ma_anagrafiche/ditte_classificazioni>} fs
 * 
 * @return {JSFoundSet}
 *
 * @properties={typeid:24,uuid:"573A6A41-D826-4D6E-AA22-22604EBD95B3"}
 */
function filterRaggruppamentoDettaglio(fs)
{
	fs.addFoundSetFilterParam('iddittaclassificazione','IN',vIdDittaClassificazione);
	return fs;
	
//	return filter(fs
//		          , 'SELECT idDettaglio FROM [dbo].[F_Ditta_Raggruppamenti_Al](?,?,?)'
//				  , [vIdDitta, vDateTo, vRaggruppamentoTipoCampo]);
}

/**
 * @properties={typeid:24,uuid:"941B7272-62E2-4A80-880D-AE06684B83D3"}
 */
function filter(fs, sql, args)
{
	var table = databaseManager.getTable(fs);
	if (!table)
		throw 'Table not found for datasource: ' + fs.getDataSource();
	
	var pkName = table.getRowIdentifierColumnNames()[0];
	
	var ds = databaseManager.getDataSetByQuery(globals.Server.MA_ANAGRAFICHE, sql, args, -1);
	if(ds.getMaxRowIndex() > 0)
		fs.addFoundSetFilterParam(pkName, 'IN', ds.getColumnAsArray(1));
	
	return fs;
}

/**
 * @param {Array<JSRecord<db:/ma_presenze/e2tabgruppicontrattuali>>} records
 *
 * @properties={typeid:24,uuid:"A128E631-0278-4E38-B844-13F008ACC639"}
 */
function updateContratto(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.radicecontratto + ' - ' + record.descrizione);
			}
		);
		
		vContrattoString = temp.join('\n');
		vContrattoStringText = temp.join(',');
		vContratto = records.map(function(record){ return record.radicecontratto; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_presenze/e2tabqualifiche>>} records
 *
 * @properties={typeid:24,uuid:"633EB50D-265B-4156-976B-2A41CCF6FFAA"}
 */
function updateQualifica(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.radicequalifica + ' - ' + record.descrizione);
			}
		);
		
		vQualificaString = temp.join('\n');
		vQualificaStringText = temp.join(',');
		vQualifica = records.map(function(record){ return record.radicequalifica; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/ditte_inps>>} records
 *
 * @properties={typeid:24,uuid:"E90E243E-597F-4018-A551-454307086124"}
 */
function updatePosizioneInps(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.posizioneinps + ' - ' + record.ditte_inps_to_ditte_attivita.descrizioneateco);
			}
		);
		
		vPosizioneInpsString = temp.join('\n');
		vPosizioneInpsStringText = temp.join(',');
		vPosizioniInps = records.map(function(record){ return record.posizioneinps; });
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/ditte_sedi>>} records
 *
 * @properties={typeid:24,uuid:"7D58C3F0-C2D2-43DE-9F29-D4F4361CDC15"}
 */
function updateSedeLavoro(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.codice + ' - ' + record.descrizione);
			}
		);
		
		vSediLavoroString = temp.join('\n');
		vSediLavoroStringText = temp.join(',');
		vSediLavoro = records.map(function(record){ return record.iddittasede; });
	}
}

/**
 * @param {JSRecord<db:/ma_anagrafiche/ditte_presenzegruppigestione>} record
 *
 * @properties={typeid:24,uuid:"8923169D-A1CC-4E3B-B0DE-312D5C79346C"}
 */
function updateGruppoLavoratori(record)
{
	if(record)
	{
		vGruppoLavoratoriString = record.codice + ' - ' + record.descrizione;
		vGruppoLavoratori = record.codice; 
	}
}

/**
 * @param {Array<JSRecord<db:/ma_anagrafiche/v_ditte_raggruppamenti_dettaglio>>} records
 *
 * @properties={typeid:24,uuid:"AE7917A4-E403-44DD-8559-3FC384C42B1E"}
 */
function updateRaggruppamentoDettaglio(records)
{
	if(records)
	{
		var temp = [];
		records.forEach
		(
			function(record)
			{
				temp.push(record.codice + ' - ' + record.descrizione);
			}
		);
		
		vRaggruppamentiDettaglioString = temp.join('\n');
		vRaggruppamentiDettaglioStringText = temp.join(',');
		vRaggruppamentiDettaglio = records.map(function(record){ return record.codice; });
	}
}

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"42E81847-B570-4238-A5C3-FA6B591BCC01"}
 */
function onShowForm(firstShow, event)
{
	vDateTo = globals.TODAY;
    resetAll();
	
	foundset.removeFoundSetFilterParam('ftr_idditta');
    foundset.addFoundSetFilterParam('idditta','=',forms.giorn_header.idditta,'ftr_idditta');
    foundset.loadAllRecords();
}

/**
 * @properties={typeid:24,uuid:"5337A3FE-44A3-4098-B601-1EEE54D63022"}
 */
function resetAll()
{
	globals.resetAll(controller.getName());
	
	var jsForm = solutionModel.getForm(controller.getName());
	var lbls = jsForm.getLabels();
	for(var label in lbls)
	{
		if(elements[lbls[label].name])
			elements[lbls[label].name].enabled = false;
	}
}

/**
 * @properties={typeid:24,uuid:"44D6913A-A57E-42C5-9955-ED15938C1EB6"}
 */
function filterLavoratori(fs)
{
	fs.addFoundSetFilterParam('idditta', globals.ComparisonOperator.EQ, idditta);
	
	/**
	 * Filtri anagrafici
	 */
	if(forms.stampa_filtri_anagrafici.vFilterContratto)
		fs.addFoundSetFilterParam('codcontratto', 'IN', vContratto);
	
	if(forms.stampa_filtri_anagrafici.vFilterQualifica)
		fs.addFoundSetFilterParam('codqualifica', 'IN', vQualifica);
	
	if(forms.stampa_filtri_anagrafici.vFilterPosizioneInps)
		fs.addFoundSetFilterParam('posizioneinps', 'IN', vPosizioniInps);
	
	if(forms.stampa_filtri_anagrafici.vFilterRaggruppamento)
		fs.addFoundSetFilterParam('lavoratori_to_lavoratori_classificazioni.codtipoclassificazione', globals.ComparisonOperator.EQ, vRaggruppamento);
	
	if(forms.stampa_filtri_anagrafici.vRaggruppamentiDettaglio)
		fs.addFoundSetFilterParam('lavoratori_to_lavoratori_classificazioni.codclassificazione', 'IN', vRaggruppamentiDettaglio);
	
	// TODO aggiunta campo filtro per gruppi lavoratori
	
	return fs;
}

/**
 * @properties={typeid:24,uuid:"281421AD-483F-441C-AC0F-EB060C967FDE"}
 */
function gotoBrowse()
{
	elements.fld_raggruppamento.enabled = false;
}

/**
 * Handle changed data.
 *
 * @param {Number} oldValue old value
 * @param {Number} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"89682543-48C3-4D4A-A16F-A909066A64A0"}
 */
function onDataChangeGruppoLavoratori(oldValue, newValue, event) 
{
    if(!newValue)
    {
    	vGruppoLavoratori = '';
    	vGruppoLavoratoriString = '';
    	elements.btn_gruppo_lavoratori.enabled = false;
    }
    else
    	elements.btn_gruppo_lavoratori.enabled = true;
    
	return true
}
